<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - File Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bs-primary-rgb: 0, 61, 165;
            --bs-body-font-family: 'Inter', sans-serif;
            --bs-body-bg: #f8f9fa;
        }
        body {
            font-family: var(--bs-body-font-family);
        }
        .container {
            max-width: 960px;
        }
        .card-header {
            background-color: transparent;
        }
    </style>
</head>
<body class="py-5">
    <div class="container">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0 text-primary">Административен панел</h1>
            <a href="/" class="btn btn-outline-secondary">← Обратно към чата</a>
        </header>

        <div id="status-message-container"></div>

        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Синхронизация на чатове</h2>
            </div>
            <div class="card-body">
                <p class="card-text text-muted">Качете цялата история на чатовете от базата данни във Vector Store на асистента. Това ще му позволи да използва минали разговори като база знания.</p>
                <button id="sync-chats-btn" class="btn btn-secondary">Синхронизирай чатове</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="h5 mb-0">Управление на файлове</h2>
            </div>
            <div class="card-body">
                <form id="upload-form" class="mb-4">
                    <div class="input-group">
                        <input type="file" class="form-control" id="file-input" name="file" required>
                        <button type="submit" id="upload-btn" class="btn btn-primary">Качи файл</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Име на файл</th>
                                <th>Дата на качване</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="file-list-tbody">
                            <!-- Files will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="file-list-loader" class="text-center p-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const uploadForm = document.getElementById('upload-form');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const fileListTbody = document.getElementById('file-list-tbody');
            const statusContainer = document.getElementById('status-message-container');
            const syncChatsBtn = document.getElementById('sync-chats-btn');
            const loader = document.getElementById('file-list-loader');

            const showStatus = (message, type = 'success') => {
                const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                      ${message}
                                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                   </div>`;
                statusContainer.innerHTML = alertHtml;
            };

            const loadFiles = async () => {
                loader.style.display = 'block';
                fileListTbody.innerHTML = '';
                try {
                    const response = await fetch('/api/vector-store/files');
                    if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch files.');

                    const files = await response.json();
                    if (files.length === 0) {
                        fileListTbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Няма качени файлове.</td></tr>';
                    } else {
                        files.sort((a, b) => b.created_at - a.created_at);
                        files.forEach(file => {
                            const row = fileListTbody.insertRow();
                            row.innerHTML = `
                                <td>${file.filename}</td>
                                <td>${new Date(file.created_at * 1000).toLocaleString('bg-BG')}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" data-file-id="${file.id}">Изтрий</button>
                                </td>
                            `;
                        });
                    }
                } catch (error) {
                    showStatus(error.message, 'danger');
                } finally {
                    loader.style.display = 'none';
                }
            };

            fileListTbody.addEventListener('click', async (e) => {
                if (e.target.matches('.btn-outline-danger')) {
                    const fileId = e.target.dataset.fileId;
                    if (confirm('Сигурни ли сте, че искате да изтриете този файл?')) {
                        const button = e.target;
                        button.disabled = true;
                        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                        try {
                            const response = await fetch(`/api/vector-store/files/${fileId}`, { method: 'DELETE' });
                            if (!response.ok) throw new Error((await response.json()).error || 'Failed to delete file.');
                            showStatus('Файлът е успешно изтрит.', 'success');
                            loadFiles();
                        } catch (error) {
                            showStatus(error.message, 'danger');
                            button.disabled = false;
                            button.textContent = 'Изтрий';
                        }
                    }
                }
            });

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!fileInput.files[0]) return;

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Качване...';

                try {
                    const response = await fetch('/api/vector-store/files', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error((await response.json()).error || 'Failed to upload file.');
                    const result = await response.json();
                    showStatus(`Файлът "${result.filename}" е успешно качен.`, 'success');
                    uploadForm.reset();
                    loadFiles();
                } catch (error) {
                    showStatus(error.message, 'danger');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = 'Качи файл';
                }
            });

            syncChatsBtn.addEventListener('click', async () => {
                syncChatsBtn.disabled = true;
                syncChatsBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Синхронизиране...';

                try {
                    const response = await fetch('/api/sync-chats', { method: 'POST' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to sync chats.');
                    showStatus(result.message || 'Синхронизацията е успешна!', 'success');
                    loadFiles();
                } catch (error) {
                    showStatus(error.message, 'danger');
                } finally {
                    syncChatsBtn.disabled = false;
                    syncChatsBtn.textContent = 'Синхронизирай чатове';
                }
            });

            loadFiles();
        });
    </script>
</body>
</html>
